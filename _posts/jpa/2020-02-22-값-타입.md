---
title: "[JPA] ê°’ íƒ€ì…"
categories:
  - Programing
tags:
  - JPA
toc: true
toc_sticky: true
date: 2020-02-22 18:30:00+09:00 
last_modified_at: 2020-02-22 18:30:00+09:00
excerpt: JPAì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°’ íƒ€ì…ì— ëŒ€í•´ì„œ ì•Œì•„ë³¸ë‹¤.
---

## ë“¤ì–´ê°€ë©°
í•´ë‹¹ ê¸€ì€ ìë°” ORM í‘œì¤€ í”„ë¡œê·¸ë˜ë°ì„ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.

JPAì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°’ íƒ€ì…ì— ëŒ€í•´ì„œ ì•Œì•„ë³¸ë‹¤. 
ê°€ì¥ í¬ê²Œ ë¶„ë¥˜í•˜ë©´ ì—”í‹°í‹° íƒ€ì…ê³¼ ê°’ íƒ€ì…ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆëŠ”ë° ì—”í‹°í‹° íƒ€ì…ì€ `@Entity`ë¡œ ì •ì˜í•œ ê°ì²´ì´ê³ ,
ê°’ íƒ€ì…ì€ integer, Stringê³¼ ê°™ì€ ë‹¨ìˆœí•œ ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ìë°” ê¸°ë³¸ íƒ€ì…ì´ë‚˜ ê°ì²´ë¥¼ ë§í•œë‹¤.

## ê¸°ë³¸ê°’ íƒ€ì…
- ìë°”ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ë³¸ ê°’ íƒ€ì…
  - String, int, Integer, Double ë“±
   
## ì„ë² ë””ë“œ íƒ€ì…(ë³µí•© ê°’ íƒ€ì…)

Profileì—ì„œ ì¤‘ë³µë˜ëŠ” address, phoneNumber, email í•„ë“œì— ëŒ€í•´ì„œ
`Embedded` ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ í•˜ë‚˜ì˜ í•„ë“œë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤.

ê°œì„  ì „
```java
@Entity
public class AdminProfile {
    @Id
    @GeneratedValue
    private Long id;

    private String address;
    private String phoneNumber;
    private String email;
}

@Entity
public class UserProfile {
    @Id
    @GeneratedValue
    private Long id;

    private String address;
    private String phoneNumber;
    private String email;
}
```

`PrivateData`ë¼ëŠ” `Embedded` ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ Profile ê°ì²´ì—ì„œ ì¤‘ë³µë˜ëŠ” ë¶€ë¶„ì„
í•˜ë‚˜ì˜ ì„ë² ë””ë“œ ê°ì²´ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

ì±…ì—ì„œëŠ” ì„ë² ë””ë“œ ê°ì²´ë¥¼ ì‚¬ìš©í•¨ì— ìˆì–´ì„œ ê°ì²´ì§€í–¥ì ì¸ ì½”ë“œì™€ ì‘ì§‘ë ¥ì„ ë†’ì¸ë‹¤ê³  ë˜ì–´ ìˆì§€ë§Œ í¬ê²Œ ì™€ë‹¿ì§€ëŠ” ëª»í–ˆë‹¤.ğŸ˜¢

ë‚´ ìƒê°ìœ¼ë¡œëŠ” ì—¬ëŸ¬ ì—”í‹°í‹°ì—ì„œ ë¬¶ì–´ì„œ ê´€ë¦¬í•´ì•¼ í•˜ëŠ” ë°ì´í„° í•„ë“œë¼ë©´ ì„ë² ë””ë“œë¡œ ë§Œë“œëŠ” ê²ƒì´ ì¢‹ì•„ë³´ì´ì§€ë§Œ
ë‹¨ìˆœíˆ ì¤‘ë³µë˜ëŠ” í•„ë“œë¥¼ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ë¬¶ì–´ë²„ë¦¬ëŠ” ì¼€ì´ìŠ¤ë©´ ë‚˜ì¤‘ì— ë³€ê²½ì´ ë°œìƒí–ˆì„ ë•Œ ë” ì–´ë ¤ì›€ì´ ìˆì„ ê²ƒ ê°™ë‹¤. 

ê°œì„  
```java
@Entity
public class UserProfile {
    @Id
    @GeneratedValue
    private Long id;

    @Embedded
    PrivateData privateData;
}

@Entity
public class AdminProfile {
    @Id
    @GeneratedValue
    private Long id;

    @Embedded PrivateData privateData;
}

@Embeddable
public class PrivateData {
    private String address;
    private String phoneNumber;
    private String email;
}
```

ë§Œì•½ì— ì„ë² ë””ë“œ ê°ì²´ë¥¼ ì—”í‹°í‹°ì—ì„œ 2ê°œ ì´ìƒ ê°€ì ¸ì•¼ í•˜ëŠ” ê²½ìš°ì—” @AttributeOverrideë¥¼ í†µí•´ì„œ
í•„ë“œ ì´ë¦„ì„ ë³€ê²½í•´ì¤˜ì•¼ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

```java
@Entity
public class UserProfile {
    @Id
    @GeneratedValue
    private Long id;

    @Embedded
    PrivateData privateData;

    @Embedded
    @AttributeOverrides({
            @AttributeOverride(name = "address", column = @Column(name = "office_address")),
            @AttributeOverride(name = "phoneNumber", column = @Column(name = "office_phone_number")),
            @AttributeOverride(name = "email", column = @Column(name = "office_email"))
    })
    PrivateData officePrivateData;
}
```

```sql
Hibernate: 
    create table user_profile (
       id bigint not null,
        office_address varchar(255),
        office_email varchar(255),
        office_phone_number varchar(255),
        address varchar(255),
        email varchar(255),
        phone_number varchar(255),
        primary key (id)
    )
```

- @Embedded : ê°’ íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” ê³³ì— í‘œì‹œ
- @Embeddable : ê°’ íƒ€ì…ì„ ì •ì˜í•˜ëŠ” ê³³ì— í‘œì‹œ
- @AttributeOverrides: ì—¬ëŸ¬ê°œì˜ ì†ì„±ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ ì‚¬ìš©
- @AttributeOverride: ì†ì„± ì¬ì •ì˜
- ì„ë² ë””ë“œ íƒ€ì…ì´ nullableì´ë©´ ë§¤í•‘í•œ ì»¬ëŸ¼ ê°’ì€ ëª¨ë‘ nullableì´ ëœë‹¤.

## ê°’ íƒ€ì… ê³µìœ  ì°¸ì¡°

### ê°’ íƒ€ì„ ê³µìœ  ì°¸ì¡° ë¬¸ì œ
- ì„ë² ë””ë“œ íƒ€ì… ê°™ì€ ê°’ íƒ€ì…ì„ ì—¬ëŸ¬ ì—”í‹°í‹°ì—ì„œ ê³µìœ í•˜ë©´ ìœ„í—˜í•˜ë‹¤.

```java
@Test
void ì„ë² ë””ë“œ_ê°ì²´_ê³µìœ ì‹œì—_ë¬¸ì œ_í…ŒìŠ¤íŠ¸() {
  AdminProfile firstAdmin = new AdminProfile();
  PrivateData privateData = new PrivateData("ì„œìš¸", "000-000-000", "abc@naver.com");

  firstAdmin.setPrivateData(privateData);

  em.persist(firstAdmin); em.flush();

  AdminProfile secondAdmin = new AdminProfile();
  PrivateData firstPrivateData = firstAdmin.getPrivateData();
  firstPrivateData.setAddress("ì¸ì²œ");

  secondAdmin.setPrivateData(firstPrivateData);

  em.persist(secondAdmin); em.flush();

  AdminProfile firstAdminResult = em.find(AdminProfile.class, firstAdmin.getId());
  AdminProfile secondAdminResult = em.find(AdminProfile.class, secondAdmin.getId());

  System.out.println("firstAdmin address: " + firstAdminResult.getPrivateData().getAddress());
  System.out.println("secondAdmin address: " + secondAdminResult.getPrivateData().getAddress());
}
```

```java
firstAdmin address: ì¸ì²œ
secondAdmin address: ì¸ì²œ
```

- í•´ë‹¹ ë°©ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•˜ëŠ” ê²½ìš° firstAdminê³¼ secondAdminì— ëŒ€í•´ì„œ UPDATE SQLì´ ì‹¤í–‰ëœë‹¤.
- PrivateDataê°€ firstAdminì—ì„œë„ ì°¸ì¡°í•˜ê³  ìˆê¸° ë•Œë¬¸ì— secondAdminì—ì„œ ì¬ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì°¸ì¡°í•˜ê³  ìˆëŠ” ê°ì²´ì— ë¶€ì‘ìš©(side effect)ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

### ê°’ íƒ€ì… ê³µìœ  ì°¸ì¡° í•´ê²°
- ì°¸ì¡° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ì°¸ì¡°í•˜ëŠ” ê°ì²´ê°€ ì•„ë‹Œ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
- ì°¸ì¡° ë¬¸ì œë¥¼ í•´ê²° í•˜ê¸° ìœ„í•´ì„œëŠ” ê°ì²´ë¥¼ ë¶ˆë³€í•˜ê²Œ ë§Œë“¤ì–´ ê°’ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ê²Œ í•˜ë¯€ë¡œ ë¶€ì‘ìš©ì„ ì›ì²œ ì°¨ë‹¨í•  ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ ê°’ íƒ€ì…ì€ ë  ìˆ˜ ìˆìœ¼ë©´ ë¶ˆë³€ ê°ì²´(immutable Object)ë¡œ ì„¤ê³„í•´ì•¼ í•œë‹¤.
  - Setter methodë¥¼ ë§Œë“¤ì§€ ì•Šì•„ ë¶ˆë³€ ê°ì²´ê°€ ë  ìˆ˜ ìˆê²Œ í•œë‹¤.
  - lombokì˜ `@Value` ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ final classê°€ ë˜ê²Œ í•œë‹¤.
  
```java
@Value
@Embeddable
public class PrivateData {
    private String address;
    private String phoneNumber;
    private String email;
}
```
compile ê²°ê³¼ setterëŠ” ìƒì„±ë˜ì§€ ì•Šê³  í´ë˜ìŠ¤, í•„ë“œì— finalì´ ì¶”ê°€ë˜ì–´ ê°ì²´ê°€ ìƒì„± ëœë‹¤.

```java
@Embeddable
public final class PrivateData {
    private final String address;
    private final String phoneNumber;
    private final String email;

    public PrivateData(String address, String phoneNumber, String email) {
        this.address = address;
        this.phoneNumber = phoneNumber;
        this.email = email;
    }
    ...
}
```

## ê°’ íƒ€ì… ì»¬ë ‰ì…˜
- @ElementCollection : í•´ë‹¹ ì»¬ë ‰ì…˜ì€ ì‹ ê·œ í…Œì´ë¸”ë¡œ ìƒì„±ëœë‹¤.

```java
@Data
@Entity
public class User {
    @Id @GeneratedValue
    private Long id;

    @CollectionTable
    @ElementCollection
    List<String> interestList = new ArrayList<>();
}
```

```sql
Hibernate: 
    create table user (
       id bigint not null,
        primary key (id)
    )
Hibernate: 
    create table user_interest_list (
       user_id bigint not null,
        interest_list varchar(255)
    )
```

- @CollectionTable
  - @ElementCollectionë¡œ í…Œì´ë¸” ìƒì„±ì‹œ ì›í•˜ëŠ” ì´ë¦„ê³¼ ì¡°ì¸ ì»¬ëŸ¼ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
  - ìƒëµ ê°€ëŠ¥í•˜ë‹¤.
  - ê¸°ë³¸ê°’: {ì—”í‹°í‹°ì´ë¦„}_{ì»¬ë ‰ì…˜ ì†ì„± ì´ë¦„}, ì˜ˆë¥¼ ë“¤ì–´ User ì—”í‹°í‹°ì˜ interestListëŠ” user_interest_list í…Œì´ë¸”ê³¼ ë§¤í•‘í•œë‹¤.
- ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì€ ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´ ì œê±° ê¸°ëŠ¥ì„ í•„ìˆ˜ë¡œ ê°€ì§„ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.
- ê°’ íƒ€ì„ ì»¬ë ‰ì…˜ì„ ì¡°íšŒí•  ë•Œ í˜ì¹˜ ì „ëµì€ LAZYê°€ ê¸°ë³¸ ê°’ì´ë‹¤.

```java
@Target( { METHOD, FIELD })
@Retention(RUNTIME)
public @interface ElementCollection {
    ...
    FetchType fetch() default LAZY;
}
```

### ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì˜ ì œì•½ì‚¬í•­
- ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì˜ ê²½ìš° ì‹ë³„ì ê°’ì´ ì—†ê¸° ë•Œë¬¸ì— ê°’ ë³€ê²½ì´ ë°œìƒí–ˆì„ ë•Œ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” ì›ë³¸ ë°ì´í„°ë¥¼ ì°¾ê¸° ì–´ë µë‹¤ëŠ” ë¬¸ì œê°€ ìˆë‹¤.
- ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì˜ ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´ JPAì—ì„œëŠ” í•´ë‹¹ í…Œì´ë¸”ì— ê°’ì„ ì „ì²´ DELETE í›„ ìƒˆë¡­ê²Œ INSERT í•œë‹¤.

```java
@DataJpaTest
class ElementCollectionTest {
    @Autowired
    private TestEntityManager em;

    @Test
    void changeElementCollectionTest() {
        User user = new User();
        List<String> interestList = user.getInterestList();
        interestList.add("ì¶•êµ¬");
        interestList.add("ë…¸ë˜");
        interestList.add("ì—¬í–‰");

        em.persist(user); em.flush();

        interestList.remove("ë…¸ë˜");
        interestList.add("ìš”ë¦¬");

        em.persist(user); em.flush();
    }
}
```

```sql
Hibernate: // user insert 
    insert 
    into
        user
        (id) 
    values
        (?)
Hibernate: // user interest insert (ì¶•êµ¬, ë…¸ë˜, ì—¬í–‰)
    insert 
    into
        user_interest_list
        (user_id, interest_list) 
    values
        (?, ?)
        
ìƒëµ...        
// ElementCollectionì— ë³€ê²½ì´ ë°œìƒí•˜ì—¬ delete query ì‹¤í–‰
Hibernate: 
    delete 
    from
        user_interest_list 
    where
        user_id=?
Hibernate: // user interest insert(ì¶•êµ¬,ì—¬í–‰,ìš”ë¦¬)  
    insert 
    into
        user_interest_list
        (user_id, interest_list) 
    values
        (?, ?)
...ìƒëµ                        
```
- ë”°ë¼ì„œ ë°ì´í„° ë³€ê²½ì´ ë°œìƒí•˜ëŠ” ê²½ìš° ì¼ëŒ€ë‹¤ ê´€ê³„ë¥¼ ê³ ë ¤í•˜ëŠ”ê²Œ ì¢‹ë‹¤.
- ì¼ëŒ€ë‹¤ ê´€ê³„ì—ì„œ ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´ ì œê±° ê¸°ëŠ¥ì„ ì ìš©í•˜ë©´ ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

## ë§ˆì¹˜ë©°
ì„ë² ë””ë“œ ê°ì²´ë¥¼ í™œìš©í•˜ì—¬ ì—”í‹°í‹° íƒ€ì…ì—ì„œ ê³µí†µìœ¼ë¡œ ê´€ë¦¬í•´ì•¼ í•˜ëŠ” í•„ë“œë¥¼ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ ì•Œì•„ë³´ì•˜ë‹¤.
í•˜ì§€ë§Œ ì„ë² ë””ë“œ ê°ì²´ë¥¼ ì‚¬ìš©í•  ê²½ìš° ê°ì²´ë¥¼ ì¬ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì•¼ í•˜ë©°, ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
ë¶ˆë³€ ê°ì²´ë¡œ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.

ê°„ë‹¨í•˜ê²Œ 1:N ê´€ê³„ë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ElementCollectionì— ëŒ€í•´ì„œë„ ì•Œì•„ë³´ì•˜ë‹¤. 
ElementCollectionì„ ì‚¬ìš©í•  ë•ŒëŠ” ë³€ê²½ì´ ë°œìƒí•˜ì§€ ì•ŠëŠ” historyì— ëŒ€í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ”
ì„±ëŠ¥ìƒ ë¬¸ì œê°€ ì—†ì§€ë§Œ ìì£¼ ë³€ê²½ì´ ë°œìƒí•˜ëŠ” ê²½ìš°ëŠ” OneToMany ê´€ê³„ë¥¼ ì´ìš©í•˜ëŠ”ê±¸ ì¶”ì²œí•œë‹¤. 
- - -

- [JPA ë¦¬ë·°]({% post_url book_review/2020-02-02-ìë°”-ORM-í‘œì¤€-í”„ë¡œê·¸ë˜ë°-ì±…-ë¦¬ë·° %}) ê¸€ ë³´ëŸ¬ê°€ê¸°

- - - 


 