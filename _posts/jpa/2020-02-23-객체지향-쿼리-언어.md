---
title: "[JPA] ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´(Query DSL)"
categories:
  - Programing
tags:
  - JPA
toc: true
toc_sticky: true
date: 2020-02-23 17:20:00+09:00 
last_modified_at: 2020-02-23 21:20:00+09:00
excerpt: JPAì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì¢…ë¥˜ì— ëŒ€í•´ ì†Œê°œí•˜ê³  Query DSLì—ì„œ ì–´ë–¤ ì‹ìœ¼ë¡œ 
         ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ì•Œì•„ë³¸ë‹¤.
---

## ë“¤ì–´ê°€ë©°
í•´ë‹¹ ê¸€ì€ ìë°” ORM í‘œì¤€ í”„ë¡œê·¸ë˜ë°ì„ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.

JPAì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì¢…ë¥˜ì— ëŒ€í•´ ì†Œê°œí•˜ê³  Query DSLì—ì„œ ì–´ë–¤ ì‹ìœ¼ë¡œ 
ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ì•Œì•„ë³¸ë‹¤.

## ê°ì²´ ì§€í–¥ ì¿¼ë¦¬ ì†Œê°œ
### JPQL
- ì—”í‹°í‹° ê°ì²´ë¥¼ ì¡°íšŒí•˜ëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬ì´ë‹¤.
- JPQLì€ SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤.
- SQL ë³´ë‹¤ ê°„ê²°í•˜ë‹¤.
- ì˜¤íƒ€ê°€ ë°œìƒì‹œì— ì»´íŒŒì¼ ì‹œì ì— ì•Œ ìˆ˜ê°€ ì—†ë‹¤.

### Criteria Query
- Criteriaì˜ ì¥ì ì€ ë¬¸ìê°€ ì•„ë‹Œ query.select(m).where(...) ì²˜ëŸ¼ í”„ë¡œê·¸ë˜ë° ì½”ë“œë¡œ JPQLì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.
- ì»´íŒŒì¼ ì‹œì ì— ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆë‹¤.
- IDEë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë“œ ìë™ì™„ì„±ì„ ì§€ì›í•œë‹¤.
- ë™ì  ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ê¸° í¸í•˜ë‹¤.
- ì‚¬ìš©í•˜ê¸° ë¶ˆí¸í•˜ê³ , ì‘ì„±í•œ ì½”ë“œë„ í•œëˆˆì— ë“¤ì–´ì˜¤ì§€ ì•ŠëŠ” ë‹¨ì ì´ ìˆë‹¤.

### Native SQL
- ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì¡´í•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì•¼ í•  ë•Œ ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³€ê²½í•˜ê²Œ ë˜ë©´ ë„¤ì´í‹°ë¸Œ SQLë„ ë³€ê²½í•´ì•¼ í•œë‹¤.
- em.createNativeQuery()ë¥¼ ì‚¬ìš©í•œë‹¤.

### Query DSL
- ì½”ë“œ ê¸°ë°˜ì´ë©´ì„œ ë‹¨ìˆœí•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰½ë‹¤.
- ì–´ë…¸í…Œì´ì…˜ í”„ë¡œì„¸ì„œë¥¼ ì‚¬ìš©í•´ì„œ ì¿¼ë¦¬ ì „ìš© í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.
- JDBC ì§ì ‘ ì‚¬ìš©, Mybatis SQL ë§¤í¼ í”„ë ˆì„ì›Œí¬ ì‚¬ìš©
- JDBCë‚˜ ë§ˆì´ë°”í‹°ìŠ¤ë¥¼ JPAì™€ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì ì ˆí•œ ì‹œì ì— ê°•ì œë¡œ í”ŒëŸ¬ì‹œí•´ì•¼ í•œë‹¤.
- JPAë¥¼ ìš°íšŒí•´ì„œ SQLì„ ì‹¤í–‰í•˜ê¸° ì§ì „ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í”ŒëŸ¬ì‹œí•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë™ê¸°í™”í•˜ë©´ ëœë‹¤.

## Query DSL
ë¬¸ìê°€ ì•„ë‹Œ ì½”ë“œë¡œ ì‘ì„±í•˜ë©´ì„œ ì‰½ê³  ê°„ê²°í•˜ë©° ê·¸ ëª¨ì–‘ë„ ì¿¼ë¦¬ì™€ ë¹„ìŠ·í•˜ê²Œ ê°œë°œí•  ìˆ˜ ìˆëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë¡œì íŠ¸ì´ë‹¤. Query DSLì„ ì‚¬ìš©í•˜ë©´ Që¡œ ì‹œì‘í•˜ëŠ” ì¿¼ë¦¬ íƒ€ì…ì˜ ì—”í‹°í‹°ë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤.

### ì…‹íŒ…
- [\[JPA\] Spring boot, gradleì—ì„œ query dsl ì…‹íŒ…í•˜ê¸°]({% post_url jpa/2020-02-23-query-dsl-setting %})

### ê²€ìƒ‰ ì¡°ê±´ ì¿¼ë¦¬

```java
@Transactional
@AutoConfigureTestEntityManager
@SpringBootTest
class UserServiceTest {
    @Autowired
    private TestEntityManager em;
   
    @Test
    void queryDslTest() {
        User user = new User();
        em.persist(user); em.flush();

        JPAQuery<User> query = new JPAQuery(em.getEntityManager());

        query.from(QUser.user)
             .where(QUser.user.id.eq(user.getId()));

        User actual = query.fetchOne();

        assertThat(actual).isNotNull();
    }
}
```

```sql
Hibernate: 
    select
        user0_.id as id1_10_ 
    from
        user user0_ 
    where
        user0_.id=?
```

### ê²°ê³¼ ì¡°íšŒ
- fetchOne()
  - ì¡°íšŒ ê²°ê³¼ê°€ í•œ ê±´ì¼ ë•Œ ì‚¬ìš©í•œë‹¤. ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ nullì„ ë°˜í™˜í•˜ê³  ê²°ê³¼ê°€ í•˜ë‚˜ ì´ìƒì´ë©´ NonUniqueResultException ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
- fetch()
  - ê²°ê³¼ê°€ í•˜ë‚˜ ì´ìƒì¼ ë•Œ ì‚¬ìš©í•œë‹¤. ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë¹ˆ ì»¬ë ‰ì…˜ì„ ë°˜í™˜í•œë‹¤.
- fetchResults()
  - ì „ì²´ ë°ì´í„° ì¡°íšŒë¥¼ ìœ„í•œ count ì¿¼ë¦¬ê°€ í•œ ë²ˆ ë” ì‹¤í–‰í•˜ê³ , QueryResults ë°˜í™˜í•˜ëŠ”ë° ì´ ê°ì²´ì—ì„œ ì „ì²´ ë°ì´í„° ìˆ˜ë¥¼ ì¡°íšŒ í•  ìˆ˜ ìˆë‹¤.  
- fetchCount()
  - í•´ë‹¹ ì¿¼ë¦¬ì˜ countë¥¼ êµ¬í•  ë•Œ ì‚¬ìš©í•œë‹¤.
  

### í˜ì´ì§•ê³¼ ì •ë ¬
- orderBy
  - í•´ë‹¹ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ ì •ë ¬
  
```java
JPAQuery<User> query = new JPAQuery(em.getEntityManager());

query.from(QUser.user)
     .where(QUser.user.id.eq(1L))
     .orderBy(QUser.user.id.desc());
```  

- offset, limit
  - í•´ë‹¹ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ ì œí•œì ì¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
  
```java
JPAQuery<User> query = new JPAQuery(em.getEntityManager());

query.from(QUser.user)
     .where(QUser.user.id.eq(1L))
     .limit(100)
     .offset(0)
     .orderBy(QUser.user.id.desc());
```  
- restrict()
  - QueryModifiers íŒŒë¼ë©”í„°ë¥¼ ì´ìš©í•´ì„œ offset, limitì„ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤.

```java
JPAQuery<User> query = new JPAQuery(em.getEntityManager());

query.from(QUser.user)
     .restrict(new QueryModifiers(100L, 0L));

QueryResults<User> result = query.fetchResults();
```  
  
### ê·¸ë£¹
- groupbyì„ ì‚¬ìš©í•˜ê³  ê·¸ë£¹í™”ëœ ê²°ê³¼ë¥¼ ì œí•œí•˜ë ¤ë©´ havingì„ ì‚¬ìš© í•˜ë©´ ëœë‹¤.

```java
QUser user = QUser.user;
query.from(user)
     .groupBy(user.name, user.id)
     .having(user.price.sum().gt(10));
```

### ì¡°ì¸
- JPQLì—ì„œë„ ë§ˆì°¬ê°€ì§€ì§€ë§Œ í•´ë‹¹ ì—”í‹°í‹°ì˜ ì°¸ì¡° ê°ì²´ë¥¼ ì‚¬ìš©í•´ì„œ joinì„ í•´ì•¼ ì˜¬ë°”ë¥¸ ë¬¸ë²•ìœ¼ë¡œ ì¸ì‹í•œë‹¤.
- innerJoin(join), leftJoin, rightJoin, fullJoinì„ ì‚¬ìš©í•  ìˆ˜ ìˆê³  ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ fetch ì¡°ì¸ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- ì¡°ì¸ì˜ ê¸°ë³¸ ë¬¸ë²•ì€ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ì¡°ì¸ ëŒ€ìƒì„ ì§€ì •í•˜ê³ , ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•  ì¿¼ë¦¬ íƒ€ì…ì„ ì§€ì •í•˜ë©´ ëœë‹¤.

```java
@Test
void queryDslJoinTest() {
  User user = new User();
  UserInventory userInventory = new UserInventory();
  user.setUserInventory(userInventory);
  em.persist(user);
  em.persist(userInventory);
  em.flush();

  JPAQuery<User> query = new JPAQuery(em.getEntityManager());
  
  QUser qUser = QUser.user;
  QUserInventory qUserInventory = QUserInventory.userInventory;
  
  query.from(qUser)
            .join(qUser.userInventory, qUserInventory)
            .where(qUser.userInventory.id.eq(userInventory.getId()));
  
  User result = query.fetchOne();
  assertThat(result).isNotNull();
}
```

```sql
Hibernate: 
    select
        user0_.id as id1_10_,
        user0_.name as name2_10_,
        user0_.price as price3_10_,
        user0_.user_inventory_id as user_inv4_10_ 
    from
        user user0_ 
    inner join
        user_inventory userinvent1_ 
            on user0_.user_inventory_id=userinvent1_.id 
    where
        user0_.user_inventory_id=?
```


### ì„œë¸Œì¿¼ë¦¬
- JPAExpressionsë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ê³  SubQueryExpressionìœ¼ë¡œ ë³€í™˜í•´ì•¼ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. 

```java
@Test
void queryDslSubQueryTest() {
  User user = new User();
  em.persist(user);
  em.flush();

  JPAQuery<User> query = new JPAQuery(em.getEntityManager());
  QUser qUser = QUser.user;
  SubQueryExpression subQueryExpression = JPAExpressions.select(qUser)
                                                 .from(qUser)
                                                 .where(qUser.name.eq("woojin"));        
  query.from(qUser)
       .where(qUser.id.in(subQueryExpression));
  List<User> result = query.fetch();

  assertThat(result).isNotNull();
}
```

```sql
Hibernate: 
    select
        user0_.id as id1_10_,
        user0_.name as name2_10_,
        user0_.price as price3_10_,
        user0_.user_inventory_id as user_inv4_10_ 
    from
        user user0_ 
    where
        user0_.id in (
            select
                user1_.id 
            from
                user user1_ 
            where
                user1_.name=?
        )
```

### í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜
- Tupleì„ ì´ìš©í•´ì„œ Mapê³¼ ë¹„ìŠ·í•œ ë‚´ë¶€ íƒ€ì…ìœ¼ë¡œ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë‹¤.

### ìˆ˜ì •, ì‚­ì œ ë°°ì¹˜ ì¿¼ë¦¬
- JPQL ë°°ì¹˜ ì¿¼ë¦¬ì™€ ê°™ì´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ **ì§ì ‘ ì¿¼ë¦¬**í•œë‹¤ëŠ” ì ì— ìœ ì˜ í•´ì•¼ í•œë‹¤.
- JPAUpdateClause, JPADeleteClauseë¥¼ ì‚¬ìš©í•œë‹¤.

### ë™ì  ì¿¼ë¦¬
- BooleanBuilderë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¹ì • ì¡°ê±´ì— ë”°ë¥¸ ë™ì  ì¿¼ë¦¬ë¥¼ í¸ë¦¬í•˜ê²Œ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

```java
@Test
void dynamicQueryTest() {
  User user = new User();
  em.persist(user);
  em.flush();

  JPAQuery<User> query = new JPAQuery(em.getEntityManager());
  QUser qUser = QUser.user;
  query.from(qUser);

  BooleanBuilder builder = new BooleanBuilder();

  String name = "woojin";
  if (name != null) {
    builder.and(qUser.name.eq(name));
  }

  query.where(builder);

  List<User> result = query.fetch();

  assertThat(result).isNotNull();
}
```

```sql
Hibernate: 
    select
        user0_.id as id1_10_,
        user0_.name as name2_10_,
        user0_.price as price3_10_,
        user0_.user_inventory_id as user_inv4_10_ 
    from
        user user0_ 
    where
        user0_.name=?
```


## ê°ì²´ ì§€í–¥ ì¿¼ë¦¬ ì‹¬í™”
### ë²Œí¬ ì—°ì‚°ì‹œ ì£¼ì˜ì 
- ë²Œí¬ ì—°ì‚°ì´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— **ì§ì ‘ ì¿¼ë¦¬** í•œë‹¤ëŠ” ì ì— ì£¼ì˜í•´ì•¼ í•œë‹¤.
- ì—…ë°ì´íŠ¸ ë²Œí¬ ì—°ì‚°ì„ í•œ í›„ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í†µí•´ì„œ ì¡°íšŒí•˜ê²Œ ë˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—
 ì´ë¯¸ ì¡´ì¬í–ˆë˜ ì—”í‹°í‹°ì˜ ê²½ìš° ë³€ê²½ë˜ì§€ ì•Šì€ ê°’ìœ¼ë¡œ ì¡°íšŒê°€ ë  ìˆ˜ ìˆë‹¤.

#### í•´ê²° ë°©ë²•
- em.refresh() ì‚¬ìš©
- ë²Œí¬ ì—°ì‚° ë¨¼ì € ì‹¤í–‰ í›„ ì¡°íšŒ
- ë²Œí¬ ì—°ì‚° ìˆ˜í–‰ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”(em.clear())

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ JPQL
- select m from Member m // ì—”í‹°í‹° ì¡°íšŒ(ê´€ë¦¬O)
- select o.address from Order o //ì„ë² ë””ë“œ íƒ€ì… ì¡°íšŒ(ê´€ë¦¬X)
- select m.id, m.username from Member m // ë‹¨ìˆœ í•„ë“œ ì¡°íšŒ (ê´€ë¦¬X)
- JPQLë¡œ ì¡°íšŒí•œ ì—”í‹°í‹°ëŠ” ì˜ì†ìƒíƒœì´ë‹¤.
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•œë‹¤.
  - ê°™ì€ ì‹ë³„ìë¥¼ ê°€ì§„ ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì¤‘ë³µí•´ì„œ ì¡´ì¬í•  ìˆ˜ ì—†ë‹¤
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ê°€ ìˆ˜ì • ì¤‘ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¨ ê²ƒê³¼ ëŒ€ì²´í•  ìˆ˜ ì—†ë‹¤
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•œ ë°ì´í„°ëŠ” ë™ì¼ì„±ì„ ë³´ì¥í•´ì•¼ í•˜ê¸°ì— ìƒˆë¡œ ê²€ìƒ‰í•œ ì—”í‹°í‹°ë¥¼ ë²„ë¦¬ê³  ê¸°ì¡´ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•œë‹¤.

### find() vs JPQL
- find()ì˜ ê²½ìš° ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì¡´ì¬í•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•˜ì§€ë§Œ
 JPQLì€ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒë¥¼ í•œ í›„ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¹„êµ í›„ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•œë‹¤.
- ë”°ë¼ì„œ JPQLë¡œ ì¡°íšŒí•˜ëŠ” ê²½ìš° SQLì´ ë§¤ë²ˆ ì‹¤í–‰ ëœë‹¤.

### JPQLê³¼ í”ŒëŸ¬ì‹œ ëª¨ë“œ
- AUTO
  - JPQL ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ê¸° ì „ê³¼ ì»¤ë°‹ì´ ì‹¤í–‰ ë  ë•Œ í”ŒëŸ¬ì‹œê°€ ë™ì‘í•œë‹¤.
- Commit
  - íŠ¸ëœì­ì…˜ ì»¤ë°‹ì´ ì‹¤í–‰ ë  ë•Œ í”ŒëŸ¬ì‹œê°€ ë™ì‘í•˜ë¯€ë¡œ ì„±ëŠ¥ì˜ ì´ì ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìœ¼ë‚˜ ì‚¬ìš©ì‹œ ì£¼ì˜ í•´ì•¼ í•œë‹¤.

## ë§ˆì¹˜ë©°
ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ëŠ” ì—¬ëŸ¬ê°€ì§€ ì¢…ë¥˜ê°€ ì¡´ì¬í•˜ì§€ë§Œ í˜„ì¬ ê°œë°œì¡°ì§ì—ì„œëŠ” Query DSLì„ ë‹¤ë£¨ê³  ìˆì–´
Query DSL ë¶€ë¶„ì— ëŒ€í•´ì„œë§Œ ì •ë¦¬í•˜ì˜€ë‹¤. 

ê° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§ˆë‹¤ ì¥ë‹¨ì ì´ ì¡´ì¬í•˜ê² ì§€ë§Œ 
ê°ì²´ë¡œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ë©´ì„œ ì‹¤ì œ ì¿¼ë¦¬ê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ê² ëŠ”ì§€ ì‰½ê²Œ ì¶”ì¸¡í•  ìˆ˜ ìˆëŠ”ê²Œ Query DSLì˜ ì¥ì  ì¸ê²ƒ ê°™ë‹¤.ğŸ‘
 
- - -

- [JPA ë¦¬ë·°]({% post_url book_review/2020-02-02-ìë°”-ORM-í‘œì¤€-í”„ë¡œê·¸ë˜ë°-ì±…-ë¦¬ë·° %}) ê¸€ ë³´ëŸ¬ê°€ê¸°

- - - 


 